global
    daemon
    log stdout local0 info
    maxconn 4096
    stats socket /tmp/haproxy.sock mode 660 level admin

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    retries 3
    option redispatch

# Frontend for write operations (routes to primary only)
frontend postgres_write_frontend
    bind *:5000
    default_backend postgres_primary_backend
    
# Frontend for read operations (load balanced across all healthy servers)
frontend postgres_read_frontend
    bind *:5001
    default_backend postgres_read_backend

# Backend for write operations - primary database only
backend postgres_primary_backend
    balance first
    option tcp-check
    
    # Simplified PostgreSQL health check - just check if port is open and accepting connections
    tcp-check connect port 5432
    
    server primary db-primary:5432 check inter 10s fall 3 rise 2 weight 100

# Backend for read operations - includes primary + all replicas
backend postgres_read_backend
    balance roundrobin
    option tcp-check
    
    # Simplified health check - just verify TCP connection
    tcp-check connect port 5432
    
    # Primary server (can handle reads too)
    server primary db-primary:5432 check inter 10s fall 3 rise 2 weight 50
    
    # Replica servers (optimized for reads)
    server replica1 db-replica-1:5432 check inter 10s fall 3 rise 2 weight 100
    server replica2 db-replica-2:5432 check inter 10s fall 3 rise 2 weight 100

# Statistics and monitoring interface
listen haproxy_stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats realm HAProxy\ Statistics
    stats admin if TRUE
    
    # Show detailed server information
    stats show-legends
    stats show-node
